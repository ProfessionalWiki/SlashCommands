(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();const u="startFragment",w="replaceFragment",C="searchFragment",S="commandsListLenght",d="countNoResultsTrying",v="wrapBlockID",r=function(){const e={startFragment:null,replaceFragment:null,searchFragment:null,insertCommandsList:null,wrapBlockID:null,commandsListLenght:0,countNoResultsTrying:0};function t(o){return Object.prototype.hasOwnProperty.call(e,o)?e[o]:null}function n(o,a){if(!Object.prototype.hasOwnProperty.call(e,o))throw new Error("Store does not have the value key");e[o]=a}function s(o){if(!Object.prototype.hasOwnProperty.call(e,o))throw new Error("Store does not have the value key");e[o]=null}return{get:t,set:n,clear:s}}();class O{constructor(e,t){this.popup=e,this.className=t,this.tagName="span",this.name="textStyle/userInput"}setUp(){this.setCeAnnotation(),this.setDmAnnotation()}setCeAnnotation(){const e=this.className,t=function(...s){t.super.apply(this,s),this.$element.addClass(e)};OO.inheritClass(t,ve.ce.TextStyleAnnotation),t.static.name=this.name,t.static.tagName=this.tagName,ve.ce.annotationFactory.register(t),t.prototype.getContentContainer=function(){const n=r.get(v);return n&&this.$element.attr("id",n),this.$element[0]}}setDmAnnotation(){const e=function(...n){e.super.apply(this,n)};OO.inheritClass(e,ve.dm.TextStyleAnnotation),e.static.name=this.name,e.static.matchTagNames=[this.tagName],ve.dm.modelRegistry.register(e)}}const T="openCommandsPopup";class P{constructor(e,t,n,s){this.popupObject=e,this.executeSymbol=t,this.fragmentResolver=n,this.commandsResolver=s,this.commandName=T,this.popup=e.getInstance()}setUp(){const e=this.commandName,t=this.executeSymbol,n=function(){n.super.call(this,e)};OO.inheritClass(n,ve.ui.Command),n.prototype.execute=s=>this.popup.isVisible()?!1:(this.surface=s,this.setID(),setTimeout(()=>{this.wrapCommandRunningSymbol(),this.showPopup(),this.bindEvents(),this.commandsResolver.focusFirstCommand(this.popup),this.unwrapCommandRunningSymbol()}),!0),ve.ui.commandRegistry.register(new n),ve.ui.sequenceRegistry.register(new ve.ui.Sequence(e,e,t))}setID(){const e="commands-popup-",t=this.makeID(7);this.ID="#"+e+t,r.set(v,e+t)}makeID(e){let t="";const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=n.length;let o=0;for(;o<e;)t+=n.charAt(Math.floor(Math.random()*s)),o+=1;return t}wrapCommandRunningSymbol(){const e=this.surface.getModel(),t=e.getFragment();r.set(u,t);const n=e.getLinearFragment(new ve.Range(t.selection.range.end-1,t.selection.range.end));n.annotateContent("set","textStyle/userInput"),r.set(w,n)}showPopup(){this.popup.toggle(!0);const e=$(document).find(".insert-commands-list-wrap"),t=this.calculatePosition();e.css({top:t.top?t.top+"px":"unset",bottom:t.bottom?t.bottom+"px":"unset",left:t.left+"px"}),e.find(".oo-ui-popupWidget-body").scrollTop(0)}calculatePosition(){const s=$(document),o=$(window).height(),a=s.scrollTop(),c=s.find(this.ID).last().offset(),m=c.top-a+17,l=o-m+7;return l<330?{top:null,bottom:l,left:c.left}:{top:m,bottom:null,left:c.left}}unwrapCommandRunningSymbol(){const e=this.surface.getModel(),t=e.getFragment(),n=e.getLinearFragment(new ve.Range(t.selection.range.end-1,t.selection.range.end));n.annotateContent("clear","textStyle/userInput"),e.getLinearFragment(new ve.Range(n.selection.range.end,n.selection.range.end)).select()}bindEvents(){this.bindKeydownEvent(),this.bindScrollEvent(),this.bindHoverEvent()}bindScrollEvent(){$(window).scroll(()=>{this.popup.toggle(!1)})}bindKeydownEvent(){this.surface.$element.find('.ve-ce-rootNode[contenteditable="true"]').on("keydown",t=>(this.tapCommandsBlock(t),this.closePopup(t),this.runCommand(t)))}bindHoverEvent(){$(document).on("mousemove",".insert-command",function(){const e=$(this);e.hasClass("selected")||($(".insert-command").removeClass("selected"),e.addClass("selected"))})}closePopup(e){const t=[37,39,9],n=this.surface.getModel().getFragment();e.keyCode!==void 0&&t.includes(e.keyCode)&&(!this.fragmentResolver.isSearchFragmentExist()||this.fragmentResolver.isOutsideSearchRange(n))&&this.popup.isVisible()&&this.popup.toggle(!1)}tapCommandsBlock(e){const t=[38,40],n=this.surface.getModel().getFragment();if(e.keyCode!==void 0&&t.includes(e.keyCode)&&this.fragmentResolver.isSearchFragmentExist()&&(this.fragmentResolver.isSearchFragmentEmpty()||!this.fragmentResolver.isOutsideSearchRange(n,!0))&&this.popup.isVisible()){e.preventDefault();const s=document.querySelector(".commands-list>.insert-command.selected"),a=[...document.querySelectorAll(".commands-list>.insert-command")],c=a.length-1;if(!a.includes(s))return;const m=a.indexOf(s);let l;e.keyCode===38&&(l=a[m>0?m-1:c]),e.keyCode===40&&(l=a[m<c?m+1:0]),s.classList.remove("selected"),l.classList.add("selected"),this.addAutoScrolling(l)}}addAutoScrolling(e){const t=e.closest(".oo-ui-popupWidget-body"),n=t.offsetHeight,s=t.getBoundingClientRect(),o=e.getBoundingClientRect(),a=t.scrollHeight;o.top<s.top&&(o.top<=0?t.scrollTop=0:t.scrollTop=t.scrollTop-o.height),o.bottom>=s.top+n&&(o.top>=a?t.scrollTop=a:t.scrollTop=t.scrollTop+o.height)}runCommand(e){const t=[13];if(e.keyCode!==void 0&&t.includes(e.keyCode)&&this.popup.isVisible()){e.preventDefault();const n=document.querySelector(".commands-list>.insert-command.selected");return this.commandsResolver.executeCommandWithElement(this.popup,e,this.fragmentResolver,n)}return!0}}class x{constructor(e,t,n){this.popup=e,this.fragmentResolver=t,this.commandsResolver=n,this.commandName="closeCommandsPopup"}setUp(){const e=this.commandName,t=function(){t.super.call(this,e)};OO.inheritClass(t,ve.ui.Command),t.prototype.execute=n=>(this.surface=n,this.searchCommand(),this.closePopup(),!0),ve.ui.commandRegistry.register(new t),ve.ui.sequenceRegistry.register(new ve.ui.Sequence(e,e,/.$/,0,{checkOnDelete:!0}))}searchCommand(){const e=r.get(u);if(e){const t=this.surface.getModel(),n=t.getFragment(),o=t.getLinearFragment(new ve.Range(e.selection.range.start,n.selection.range.end)).getText(!0);r.set(C,o),this.popup.updateContent(o),this.commandsResolver.focusFirstCommand(this.popup.getInstance())}}closePopup(){const e=this.surface.getModel().getFragment(),t=this.popup.getInstance();return e&&(this.isOutsideSearchRange(e)||this.isNoResultsTyping())&&t.isVisible()&&t.toggle(!1),!0}isOutsideSearchRange(e){const n=this.surface.getModel().getLinearFragment(new ve.Range(e.selection.range.start-1,e.selection.range.end)),s=n==null?void 0:n.getText(!0);return(!this.fragmentResolver.isSearchFragmentExist()||this.fragmentResolver.isOutsideSearchRange(e))&&s!==p}isNoResultsTyping(){const e=r.get(d),t=this.fragmentResolver.getSearchText();return e>3&&t.length>0||t.length>1&&t.slice(-2)==="  "}}const p="/";class A{constructor(e,t,n){this.popup=e,this.fragmentResolver=t,this.commandsResolver=n,this.executeSymbol=p,this.className="commands-popup-wrap"}setUp(){new O(this.popup.getInstance(),this.className).setUp(),new P(this.popup,this.executeSymbol,this.fragmentResolver,this.commandsResolver).setUp(),new x(this.popup,this.fragmentResolver,this.commandsResolver).setUp()}}class M{static create(e,t,n){const s=function(a){s.super.call(this,a)};return OO.inheritClass(s,OO.ui.PopupWidget),s.prototype.onDocumentMouseDown=function(o){this.isVisible()&&(OO.ui.contains(this.$element.find(".commands-list").get(),o.target,!0)||this.toggle(!1),t.executeCommandWithElement(this,o,n))},new s(e)}}const f="insert-command",F="no-results";class g{constructor(e,t){this.fragmentResolver=e,this.commandsResolver=t,this.className="insert-commands-list-wrap",this.commandClassName=f,this.popup=M.create({$content:$('<div class="commands-list"></div>'),classes:[this.className],hideCloseButton:!0,anchor:!1,autoClose:!0,autoFlip:!0,position:"after",verticalPosition:"above",hideWhenOutOfView:!0,width:210},t,e),this.setClosingHookHandler().then(),document.body.appendChild(this.popup.$element[0])}getInstance(){return this.popup}static getCommandClassName(){return f}async setClosingHookHandler(){this.popup.on("closing",async()=>{await this.clearContent()})}async clearContent(){var n;await this.setContent(),((n=ve.init.target)==null?void 0:n.getSurface()).$element.find('.ve-ce-rootNode[contenteditable="true"]').off("keydown"),$(window).unbind("scroll"),$(document).off("mousemove",".insert-command"),r.clear(u),r.clear(w),r.clear(C),r.clear(v),r.set(S,0),r.set(d,0)}setContent(){this.setBodyHtml(this.commandsResolver.getCommands())}setBodyHtml(e){const t=this.getCommandElTemplate(e);this.popup.$body.find(".commands-list").html(t)}updateContent(e){this.updateBodyHtml(this.commandsResolver.getCommands(e))}updateBodyHtml(e){let t="";if(e.length)t=this.getCommandElTemplate(e);else{t=`<span class="${this.commandClassName}" role="button" data-command="${F}">No results</span>`;const n=r.get(d);r.set(d,n+1)}r.set(S,e.length),this.popup.$body.find(".commands-list").html(t)}getCommandElTemplate(e){let t="";return e.forEach(function(n,s){t+=`<span class="${f}" tabindex="${s+1}" role="button" data-command="${n.command}">
					<span class="oo-ui-iconElement-icon oo-ui-icon-${n.icon||"noIcon"}"></span>
					<span class="oo-ui-tool-title">${n.title}</span>
				</span>`}),t}}class I{constructor(){var e;this.surface=(e=ve.init.target)==null?void 0:e.getSurface()}setSurface(){var e;this.surface=(e=ve.init.target)==null?void 0:e.getSurface()}isOutsideSearchRange(e,t=!1){const n=this.getSearchRange(),s=e.selection.range.start+(t?1:0),o=e.selection.range.end;return s<n.start||o>n.end||s===n.start&&n.start===n.end}isSearchFragmentExist(){return r.get(u)!==null}isSearchFragmentEmpty(){const e=this.getSearchRange();return e.start===e.end}getSearchRange(){const e=r.get(u),t=r.get(C);return{start:e.selection.range.start,end:e.selection.range.start+(t?t.length:0)}}getSearchText(){if(!this.isSearchFragmentExist())return"";const e=this.getSearchRange();return this.getFragment(e).getText(!0)}getFragment(e){return this.surface.getModel().getLinearFragment(new ve.Range(e.start,e.end))}replaceSearchFragment(){const e=this.getSearchRange(),t=this.getFragment({start:e.start-1,end:e.end});if(t!==null){const n=p+this.getSearchText();if(t.getText(!0)===n){const s=this.surface.getModel().getFragment();t.removeContent(),t.insertContent(n),this.setCursorAfterReplacing(s,e)}}}setCursorAfterReplacing(e,t){const n={start:t.end,end:t.end};e&&e.selection.range.end>t.end&&(n.start=n.end=e.selection.range.end),this.getFragment(n).select()}removeSearchFragment(){const e=this.getSearchRange(),t=e.start-1,n=this.getFragment({start:t,end:e.end});if(n!==null){const s=p+this.getSearchText();n.getText(!0)===s&&(n.removeContent(),this.getFragment({start:t,end:t}).select())}}}class L{getCommands(e=""){return this.filterCommands(this.getConfiguredCommands(e),e)}getConfiguredCommands(e){return e.length?this.getAvailableCommands():this.getPredefinedCommands()}getPredefinedCommands(){const e=mw.config.get("SlashCommands"),t=(e==null?void 0:e.Predefined)??[];return((e==null?void 0:e.Available)??[]).filter(s=>t.includes(s.command))}getAvailableCommands(){const e=mw.config.get("SlashCommands");return(e==null?void 0:e.Available)??[]}filterCommands(e,t){return t&&(e=e.filter(n=>n.title.toLowerCase().includes(t.toLowerCase())).sort((n,s)=>n.command.startsWith(t)&&s.command.startsWith(t)?0:s.command.startsWith(t)?1:-1)),e}executeCommandWithElement(e,t,n,s=null){const o=s||t.target;if(!OO.ui.contains(e.$element.get(),o,!0))return;const a=$(o),c=a.parents(`.${g.getCommandClassName()}`);if(a.hasClass(g.getCommandClassName())||c.length){const m=g.getCommandClassName(),l=a.hasClass(m)?a:c,R=this.getAllCommands(),h=l.data("command");if(h===F)return!1;if(Object.prototype.hasOwnProperty.call(R,h)){const N=ve.init.target.getSurface();return n.isSearchFragmentExist()&&n.removeSearchFragment(),e.toggle(!1),setTimeout(()=>{R[h].execute(N)}),!1}}return!0}getAllCommands(){return ve.ui.commandRegistry.registry}getCommandIcon(e){var t,n,s;return((s=(n=(t=ve.ui.contextItemFactory.registry)==null?void 0:t[e])==null?void 0:n.static)==null?void 0:s.icon)??"noIcon"}focusFirstCommand(e){setTimeout(()=>{const t=e.$body.find(".commands-list .insert-command");t.removeClass("selected"),t.first().addClass("selected")})}}const y=new I,b=new L,E=new g(y,b);new A(E,y,b).setUp();mw.hook("ve.activationComplete").add(async function(){await E.setContent(),y.setSurface()});
