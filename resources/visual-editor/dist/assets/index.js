(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();const h="startFragment",y="replaceFragment",S="searchFragment",f="insertCommandsList",O="commandsListLenght",u="countNoResultsTrying",g="wrapBlockID",a=function(){const e={startFragment:null,replaceFragment:null,searchFragment:null,insertCommandsList:null,wrapBlockID:null,commandsListLenght:0,countNoResultsTrying:0};function t(o){return Object.prototype.hasOwnProperty.call(e,o)?e[o]:null}function s(o,r){if(!Object.prototype.hasOwnProperty.call(e,o))throw new Error("Store does not have the value key");e[o]=r}function n(o){if(!Object.prototype.hasOwnProperty.call(e,o))throw new Error("Store does not have the value key");e[o]=null}return{get:t,set:s,clear:n}}();class T{constructor(e,t){this.popup=e,this.className=t,this.tagName="span",this.name="textStyle/userInput"}setUp(){this.setCeAnnotation(),this.setDmAnnotation()}setCeAnnotation(){const e=this.className,t=function(...n){t.super.apply(this,n),this.$element.addClass(e)};OO.inheritClass(t,ve.ce.TextStyleAnnotation),t.static.name=this.name,t.static.tagName=this.tagName,ve.ce.annotationFactory.register(t),t.prototype.getContentContainer=function(){const s=a.get(g);return s&&this.$element.attr("id",s),this.$element[0]}}setDmAnnotation(){const e=function(...s){e.super.apply(this,s)};OO.inheritClass(e,ve.dm.TextStyleAnnotation),e.static.name=this.name,e.static.matchTagNames=[this.tagName],ve.dm.modelRegistry.register(e)}}const P="openCommandsPopup";class x{constructor(e,t,s,n){this.popupObject=e,this.executeSymbol=t,this.fragmentResolver=s,this.commandsResolver=n,this.commandName=P,this.popup=e.getInstance()}setUp(){const e=this.commandName,t=this.executeSymbol,s=function(){s.super.call(this,e)};OO.inheritClass(s,ve.ui.Command),s.prototype.execute=n=>this.popup.isVisible()?!1:(this.surface=n,this.setID(),setTimeout(()=>{this.wrapCommandRunningSymbol(),this.setCursorPosition(),this.showPopup(),this.bindEvents(),this.focusFirstCommand()}),!0),ve.ui.commandRegistry.register(new s),ve.ui.sequenceRegistry.register(new ve.ui.Sequence(e,e,t))}setID(){const e="commands-popup-",t=this.makeID(7);this.ID="#"+e+t,a.set(g,e+t)}makeID(e){let t="";const s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=s.length;let o=0;for(;o<e;)t+=s.charAt(Math.floor(Math.random()*n)),o+=1;return t}wrapCommandRunningSymbol(){const e=this.surface.getModel(),t=e.getFragment();a.set(h,t);const s=e.getLinearFragment(new ve.Range(t.selection.range.end-1,t.selection.range.end));s.annotateContent("set","textStyle/userInput"),a.set(y,s)}setCursorPosition(){const e=a.get(y);this.surface.getModel().getLinearFragment(new ve.Range(e.selection.range.end+1,e.selection.range.end+1)).select()}showPopup(){const e=$(document).find(this.ID).last().offset();this.popup.toggle(!0),$(document).find(".insert-commands-list-wrap").css({top:e.top+17+"px",left:e.left+"px"})}bindEvents(){this.surface.$element.find(this.ID).on("DOMSubtreeModified",t=>this.searchCommand(t)),this.bindKeydownEvent()}bindKeydownEvent(){this.surface.$element.find('.ve-ce-rootNode[contenteditable="true"]').on("keydown",t=>(this.tapCommandsBlock(t),this.closePopup(t),this.runCommand(t)))}focusFirstCommand(){setTimeout(()=>{const e=this.popup.$body.find(".commands-list .insert-command");e.removeClass("selected"),e.first().addClass("selected")})}searchCommand(e){let t=e.target.innerText;t.length&&(t=t.replace("/","")),a.set(S,t),this.popupObject.updateContent(t),this.focusFirstCommand()}closePopup(e){const t=[37,39,8,9],s=this.surface.getModel().getFragment();e.keyCode!==void 0&&t.includes(e.keyCode)&&(!this.fragmentResolver.isSearchFragmentExist()||this.fragmentResolver.isOutsideSearchRange(s))&&this.popup.isVisible()&&this.popup.toggle(!1)}tapCommandsBlock(e){const t=[38,40],s=this.surface.getModel().getFragment();if(e.keyCode!==void 0&&t.includes(e.keyCode)&&this.fragmentResolver.isSearchFragmentExist()&&(this.fragmentResolver.isSearchFragmentEmpty()||!this.fragmentResolver.isOutsideSearchRange(s,!0))&&this.popup.isVisible()){e.preventDefault();const n=document.querySelector(".commands-list>.insert-command.selected"),r=[...document.querySelectorAll(".commands-list>.insert-command")],m=r.length-1;if(!r.includes(n))return;const c=r.indexOf(n);let l;e.keyCode===38&&(l=r[c>0?c-1:m]),e.keyCode===40&&(l=r[c<m?c+1:0]),n.classList.remove("selected"),l.classList.add("selected")}}runCommand(e){const t=[13];if(e.keyCode!==void 0&&t.includes(e.keyCode)&&this.popup.isVisible()){e.preventDefault();const s=document.querySelector(".commands-list>.insert-command.selected");return this.commandsResolver.executeCommandWithElement(this.popup,e,this.fragmentResolver,s)}return!0}}class A{constructor(e,t){this.popup=e,this.fragmentResolver=t,this.commandName="closeCommandsPopup"}setUp(){const e=this.commandName,t=function(){t.super.call(this,e)};OO.inheritClass(t,ve.ui.Command),t.prototype.execute=s=>(this.closePopup(s),!0),ve.ui.commandRegistry.register(new t),ve.ui.sequenceRegistry.register(new ve.ui.Sequence(e,e,/.$/,0))}closePopup(e){const t=e.getModel().getFragment(),s=this.popup.getInstance();return t&&(this.isOutsideSearchRange(t)||this.isNoResultsTyping())&&s.isVisible()&&s.toggle(!1),!0}isOutsideSearchRange(e){return!this.fragmentResolver.isSearchFragmentExist()||this.fragmentResolver.isOutsideSearchRange(e)}isNoResultsTyping(){const e=a.get(u),t=this.fragmentResolver.getSearchText();return e>3&&t.length>0||t.length>1&&t.slice(-2)==="  "}}const v="/";class M{constructor(e,t,s){this.popup=e,this.fragmentResolver=t,this.commandsResolver=s,this.executeSymbol=v,this.className="commands-popup-wrap"}setUp(){new T(this.popup.getInstance(),this.className).setUp(),new x(this.popup,this.executeSymbol,this.fragmentResolver,this.commandsResolver).setUp(),new A(this.popup,this.fragmentResolver).setUp()}}class L{static create(e,t,s){const n=function(r){n.super.call(this,r)};return OO.inheritClass(n,OO.ui.PopupWidget),n.prototype.onDocumentMouseDown=function(o){this.isVisible()&&(OO.ui.contains(this.$element.find(".commands-list").get(),o.target,!0)||this.toggle(!1),t.executeCommandWithElement(this,o,s))},new n(e)}}const C="insert-command",E="no-results";class d{constructor(e,t){this.fragmentResolver=e,this.commandsResolver=t,this.className="insert-commands-list-wrap",this.commandClassName=C,this.popup=L.create({$content:$('<div class="commands-list"></div>'),classes:[this.className],hideCloseButton:!0,anchor:!1,autoClose:!0,autoFlip:!0,position:"after",verticalPosition:"above",hideWhenOutOfView:!0,width:210},t,e),this.setClosingHookHandler(),document.body.appendChild(this.popup.$element[0])}getInstance(){return this.popup}static getCommandClassName(){return C}setClosingHookHandler(){this.popup.on("closing",()=>{this.clearContent()})}async clearContent(){var o;this.fragmentResolver.isSearchFragmentExist()&&this.fragmentResolver.replaceSearchFragment(),await this.setContent();const e=(o=ve.init.target)==null?void 0:o.getSurface(),t="#commands-popup-"+a.get(g),s=e.$element.find(t),n=e.$element.find('.ve-ce-rootNode[contenteditable="true"]');s.off("DOMSubtreeModified"),n.off("keydown"),a.clear(h),a.clear(y),a.clear(S),a.clear(g),a.set(O,0),a.set(u,0)}async setContent(){this.setBodyHtml(await this.commandsResolver.getCommands())}setBodyHtml(e){const t=this.getCommandElTemplate(e);this.popup.$body.find(".commands-list").html(t)}async updateContent(e){this.updateBodyHtml(await this.commandsResolver.getCommands(e))}updateBodyHtml(e){let t="";if(e.length)t=this.getCommandElTemplate(e);else{t=`<span class="${this.commandClassName}" role="button" data-command="${E}">No results</span>`;const s=a.get(u);a.set(u,s+1)}a.set(O,e.length),this.popup.$body.find(".commands-list").html(t)}getCommandElTemplate(e){let t="";return e.forEach(function(s,n){t+=`<span class="${C} ${s.visible?"active":"hidden"}" tabindex="${n+1}" role="button" data-command="${s.command}">
					<span class="oo-ui-iconElement-icon oo-ui-icon-${s.icon}"></span>
					<span class="oo-ui-tool-title">${s.title}</span>
				</span>`}),t}}class I{constructor(){var e;this.surface=(e=ve.init.target)==null?void 0:e.getSurface()}setSurface(){var e;this.surface=(e=ve.init.target)==null?void 0:e.getSurface()}isOutsideSearchRange(e,t=!1){const s=this.getSearchRange(),n=e.selection.range.start+(t?1:0),o=e.selection.range.end;return n<s.start||o>s.end||n===s.start&&s.start===s.end}isSearchFragmentExist(){return a.get(h)!==null}isSearchFragmentEmpty(){const e=this.getSearchRange();return e.start===e.end}getSearchRange(){const e=a.get(h),t=a.get(S);return{start:e.selection.range.start,end:e.selection.range.start+(t?t.length:0)}}getSearchText(){if(!this.isSearchFragmentExist())return"";const e=this.getSearchRange();return this.getFragment(e).getText(!0)}getFragment(e){return this.surface.getModel().getLinearFragment(new ve.Range(e.start,e.end))}replaceSearchFragment(){const e=this.getSearchRange(),t=this.getFragment({start:e.start-1,end:e.end});if(t!==null){const s=v+this.getSearchText();if(t.getText(!0)===s){const n=this.surface.getModel().getFragment();t.removeContent(),t.insertContent(s),this.setCursorAfterReplacing(n,e)}}}setCursorAfterReplacing(e,t){const s={start:t.end,end:t.end};e&&e.selection.range.end>t.end&&(s.start=s.end=e.selection.range.end),this.getFragment(s).select()}removeSearchFragment(){const e=this.getSearchRange(),t=e.start-1,s=this.getFragment({start:t,end:e.end});if(s!==null){const n=v+this.getSearchText();s.getText(!0)===n&&(s.removeContent(),this.getFragment({start:t,end:t}).select())}}}class D{async getCommands(e=""){let t=a.get(f);return(!t||t.lenght)&&a.set(f,this.getCommandsFromTheToolbar()),t=await a.get(f),this.filterCommands([...t],e)}getCommandsFromTheToolbar(){return new Promise(e=>{setTimeout(()=>{const t=[];for(const s of["style","insert","structure"]){const n=ve.init.target.toolbar.groupsByName[s].tools;Object.keys(n).forEach(function(o){const r=n[o];r.disabled===!1&&t.push({command:o,icon:r.icon,title:r.title,visible:!0})})}e(t)})})}filterCommands(e,t){return t&&(e=e.filter(s=>s.title.toLowerCase().includes(t.toLowerCase()))),e}executeCommandWithElement(e,t,s,n=null){const o=n||t.target;if(!OO.ui.contains(e.$element.get(),o,!0))return;const r=$(o),m=r.parents(`.${d.getCommandClassName()}`);if(r.hasClass(d.getCommandClassName())||m.length){const c=d.getCommandClassName(),l=r.hasClass(c)?r:m,F=this.getAllCommands(),p=l.data("command");if(p===E)return!1;if(Object.prototype.hasOwnProperty.call(F,p)){const w=ve.init.target.getSurface();s.isSearchFragmentExist()&&s.removeSearchFragment(),e.toggle(!1),setTimeout(()=>{F[p].execute(w)})}}return!0}getAllCommands(){return ve.ui.commandRegistry.registry}}const R=new I,N=new D,b=new d(R,N);new M(b,R,N).setUp();mw.hook("ve.activationComplete").add(async function(){await b.setContent(),R.setSurface()});
